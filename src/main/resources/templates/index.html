<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title th:text="${lang.pageTitle}">Guestbook</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
</head>
<body>

<div class="card">

    <header>
        <h1 th:text="${lang.heading}">Guestbook</h1>
        <p class="subtitle" th:text="${lang.subtitle}">Leave a message for the world to see.</p>
    </header>

    <section class="form-section">
        <h2 th:text="${lang.formHeading}">Write a message</h2>
        <form method="post" action="/guestbook">
            <input name="name" th:placeholder="${lang.namePlaceholder}" required/>
            <input name="message" th:placeholder="${lang.messagePlaceholder}" required/>
            <button type="submit" th:text="${lang.sendButton}">Send Message</button>
        </form>
    </section>

    <hr/>

    <section class="messages-section">
        <div th:if="${#lists.isEmpty(messages)}" class="empty" th:text="${lang.noMessages}">
            No messages yet. Be the first!
        </div>

        <ul th:unless="${#lists.isEmpty(messages)}">
            <li th:each="m : ${messages}">
                <div class="message-header">
                    <b th:text="${m.name}"></b>

                    <div class="admin-actions">
                        <button type="button"
                                class="edit-btn"
                                th:classappend="${isAdmin} ? ' visible' : ''"
                                th:attr="data-id=${m.id},data-message=${m.message}"
                                onclick="openEditModal(this)"
                                title="Modifier">✎</button>

                        <form class="delete-form" th:action="'/admin/delete/' + ${m.id}" method="post">
                            <button type="submit"
                                    class="delete-btn"
                                    th:classappend="${isAdmin} ? ' visible' : ''"
                                    title="Supprimer">✕</button>
                        </form>
                    </div>
                </div>

                <span class="msg" th:text="${m.message}"></span>
                <small th:text="${m.createdAtFormatted}"></small>
            </li>
        </ul>
    </section>

    <div class="admin-area">
        <button class="admin-btn" onclick="document.getElementById('adminModal').style.display='flex'">⚙ Admin</button>
    </div>

</div>

<div id="adminModal" class="modal-overlay" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal">
        <h3>Admin</h3>

        <div th:if="${!isAdmin}">
            <p>Entrez le code admin pour activer les options.</p>

            <div id="adminError"
                 class="inline-error"
                 style="display:none"
                 th:text="${lang.admin.wrongPassword}">Code admin incorrect.</div>

            <input type="password" id="adminCodeField" placeholder="Code"/>
            <button class="danger-btn" onclick="activateAdmin()">Activer</button>
        </div>

        <div th:if="${isAdmin}">
            <p style="opacity:0.9">Connecté en admin.</p>

            <p style="font-size:0.8rem; color:rgba(255,255,255,0.35)">Vider toute la base :</p>
            <form method="post" action="/admin/clear">
                <button type="submit" class="danger-btn">Vider la DB</button>
            </form>

            <form method="post" action="/admin/logout" style="margin-top: 0.75rem">
                <button type="submit" class="cancel-btn">Se déconnecter</button>
            </form>
        </div>

        <button class="cancel-btn" onclick="document.getElementById('adminModal').style.display='none'">Fermer</button>
    </div>
</div>

<div id="editModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeEditModal()">
    <div class="modal">
        <h3>Modifier le message</h3>

        <div id="editError" class="inline-error" style="display:none">Erreur.</div>

        <input type="hidden" id="editMessageId" value=""/>
        <textarea id="editMessageField" class="modal-textarea" rows="4" placeholder="Nouveau message..."></textarea>

        <div class="edit-actions">
            <button class="danger-btn" onclick="saveEdit()">Sauvegarder</button>
            <button class="cancel-btn" onclick="closeEditModal()">Annuler</button>
        </div>
    </div>
</div>

<script>
    async function activateAdmin() {
        const code = document.getElementById('adminCodeField').value;
        const err = document.getElementById('adminError');

        err.style.display = 'none';
        err.textContent = err.textContent || 'Code admin incorrect.';

        const res = await fetch('/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ code })
        });

        if (res.ok) {
            window.location.reload();
            return;
        }

        document.getElementById('adminCodeField').value = '';
        err.style.display = 'block';
    }

    document.addEventListener('input', (e) => {
        if (e.target && e.target.id === 'adminCodeField') {
            const err = document.getElementById('adminError');
            if (err) err.style.display = 'none';
        }
    });

    function openEditModal(btn) {
        const id = btn.dataset.id;
        const msg = btn.dataset.message || '';

        document.getElementById('editMessageId').value = id;
        document.getElementById('editMessageField').value = msg;

        const err = document.getElementById('editError');
        err.style.display = 'none';

        document.getElementById('editModal').style.display = 'flex';
        setTimeout(() => document.getElementById('editMessageField').focus(), 0);
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    async function saveEdit() {
        const id = document.getElementById('editMessageId').value;
        const message = document.getElementById('editMessageField').value;

        const err = document.getElementById('editError');
        err.style.display = 'none';

        const res = await fetch('/admin/update/' + encodeURIComponent(id), {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ message })
        });

        if (res.ok) {
            window.location.reload();
            return;
        }

        err.textContent = 'Impossible de sauvegarder. (Pas admin / erreur serveur)';
        err.style.display = 'block';
    }
</script>

</body>
</html>
